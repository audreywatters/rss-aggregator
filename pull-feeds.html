---
layout: page
title: Pull Feeds
---

<script type="text/javascript">

    var $oAuth_Token = getUrlVar('token');
    var $org = 'indieedtech';
    var $repo = 'rss-aggregator';

    var options = {
      author: {name: 'Kin Lane', email: 'kinlane@gmail.com'},
      committer: {name: 'Feed Aggregator', email: 'kinlane@gmal.com'},
      encode: true // Whether to base64 encode the file. (default: true)
    }

    var github = new Github({token: $oAuth_Token,auth: "oauth"});
    var repo = github.getRepo($org,$repo);

    // RAW is only way we can get at _data
    $feedurls = 'https://raw.githubusercontent.com/indieedtech/rss-aggregator/gh-pages/_data/feed-urls.json';

    var allFeeds = $.get($feedurls, function (feeds) {
      console.log("here!");

      $feedsJSON = JSON.parse(feeds);

      $countFeeds = 0;
      $howManyFeeds = $feedsJSON.length;

      $.each($feedsJSON, function(feedKey, feedEntry) {

        $feedName = feedEntry['name'];
        console.log($feedName);
        $feedURL = feedEntry['url'];
        $existAlready = 0;

        var thisFeed = $.get($feedURL, function (feeds) {

          $countItems = 0;
          $howManyItems = $(feeds).find("item").length;

          // RAW is only way we can get at _data
          $feedurls = 'https://raw.githubusercontent.com/indieedtech/rss-aggregator/gh-pages/_data/feed-entries.json';
          var thisData = $.get($feedurls, function (data) {

            $masterFeed = JSON.parse(data);

            $(feeds).find("item").each(function () {

              $feedName = feedEntry['name'];

              var el = $(this);
              $title = el.find("title").text();
              $link = el.find("link").text();
              $pubDate = el.find("pubDate").text();
              $pubDate = dateFormat($pubDate, "mm/dd/yyyy");

              $feedentry = {};
            	$feedentry['feed'] = $feedName;
            	$feedentry['title'] = $title;
            	$feedentry['link'] = $link;
              $feedentry['pubDate'] = $pubDate;

              $existAlready = 0;
              $.each($masterFeed, function(existingKey, existingFeed) {
                  if(existingFeed['feed'] == $feedName && existingFeed['title'] == $title)
                    {
                    $existAlready = 1;
                    }
                  });

              // Add It
              if($existAlready==0){
            	  $masterFeed.push($feedentry);
                }

              $feedItem = '<li><a href="' + $link + '">' + $title + '</a> (<i>' + $feedName + ' on ' + $pubDate + '</i>)</li>';

              $('#process-feeds').append($feedItem);

              $countItems ++;
              });
            })
            .done(function() {

                $countFeeds++;

                $feedJSON = JSON.stringify($masterFeed);

                repo.write('gh-pages','_data/feed-entries.json',$feedJSON,'Pull Feed', options, function(err) {});

              })
            .fail(function() {
              // Feed failed for some reason
              //console.log("FAIL (probably CORS)");
              $howManyFeeds = $howManyFeeds - 1;

            });
          });
        });
      })
      .done(function() {
          console.log("SUCESS");
        })
      .fail(function() {
        //console.log("NO GO AT ALL!");
      });

</script>

<h2>Pull Feeds</h2>

<ul id="process-feeds"></ul>
<textarea cols="100" rows="10" id="showme" /></textarea>
